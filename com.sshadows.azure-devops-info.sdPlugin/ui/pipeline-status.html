<!DOCTYPE html>
<html>

<head lang="en">
    <title>Pipeline Status Settings</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="css/pipeline-status.css">
    <script src="https://sdpi-components.dev/releases/v4/sdpi-components.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        .debug-log {
            width: 100%;
            height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            background: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            resize: vertical;
            margin-top: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .status-message {
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        
        .status-message.success {
            background: #2ea043;
            color: white;
        }
        
        .status-message.error {
            background: #d1242f;
            color: white;
        }
        
        .status-message.testing {
            background: #fb8500;
            color: white;
        }
        
        .status-message.visible {
            display: block;
        }
    </style>
</head>

<body>
    <sdpi-item label="Organization URL">
        <sdpi-textfield setting="organizationUrl" placeholder="https://dev.azure.com/yourorg"></sdpi-textfield>
    </sdpi-item>
    
    <sdpi-item label="Project Name">
        <sdpi-textfield setting="projectName" placeholder="MyProject"></sdpi-textfield>
    </sdpi-item>
    
    <sdpi-item label="Pipeline ID">
        <sdpi-textfield setting="pipelineId" pattern="[0-9]*" placeholder="123"></sdpi-textfield>
    </sdpi-item>
    
    <sdpi-item label="Branch Name (Optional)">
        <sdpi-textfield setting="branchName" placeholder="main, develop, or refs/heads/main"></sdpi-textfield>
    </sdpi-item>
    
    <sdpi-item label="Personal Access Token">
        <sdpi-textfield setting="personalAccessToken" type="password" placeholder="Your PAT token"></sdpi-textfield>
    </sdpi-item>
    
    <sdpi-item label="Refresh Interval">
        <sdpi-range setting="refreshInterval" min="10" max="300" step="10" default="30" showlabels>
            <span slot="suffix">seconds</span>
        </sdpi-range>
    </sdpi-item>
    
    <sdpi-item label="Display Options">
        <sdpi-select setting="displayFormat" default="both">
            <option value="icon">Icon Only</option>
            <option value="text">Text Only</option>
            <option value="both">Icon and Text</option>
        </sdpi-select>
    </sdpi-item>
    
    <sdpi-item label="Show Build Number">
        <sdpi-checkbox setting="showBuildNumber" default="true"></sdpi-checkbox>
    </sdpi-item>
    
    <sdpi-item label="Show Duration">
        <sdpi-checkbox setting="showDuration" default="false"></sdpi-checkbox>
    </sdpi-item>
    
    <sdpi-item label="Test Connection">
        <div class="button-group">
            <sdpi-button id="testConnection">Test Connection</sdpi-button>
        </div>
        <div id="connectionStatus" class="status-message"></div>
    </sdpi-item>
    
    <sdpi-item label="Debug Logs">
        <div class="button-group">
            <sdpi-button id="copyLogs">Copy Logs</sdpi-button>
            <sdpi-button id="clearLogs">Clear Logs</sdpi-button>
        </div>
        <textarea id="debugLog" class="debug-log" readonly></textarea>
    </sdpi-item>
    
    <script>
        // Debug logging
        let debugLogs = [];
        const streamDeckClient = SDPIComponents.streamDeckClient;
        
        function debugLog(message, data = null) {
            const timestamp = new Date().toISOString().substring(11, 23);
            let logEntry = `[${timestamp}] ${message}`;
            if (data) {
                logEntry += '\n' + JSON.stringify(data, null, 2);
            }
            debugLogs.push(logEntry);
            
            // Keep only last 100 logs
            if (debugLogs.length > 100) {
                debugLogs.shift();
            }
            
            const debugLogElement = document.getElementById('debugLog');
            if (debugLogElement) {
                debugLogElement.value = debugLogs.join('\n\n');
                debugLogElement.scrollTop = debugLogElement.scrollHeight;
            }
        }
        
        // Initialize when connected
        streamDeckClient.onConnected(() => {
            debugLog('Connected to Stream Deck');
            
            // Get current settings
            const settings = streamDeckClient.settings;
            debugLog('Current settings', settings);
        });
        
        // Test connection button
        document.getElementById('testConnection').addEventListener('click', async () => {
            debugLog('Test Connection clicked');
            
            const statusEl = document.getElementById('connectionStatus');
            const buttonEl = document.getElementById('testConnection');
            
            // Get current settings
            const settings = streamDeckClient.settings;
            
            debugLog('Testing with settings', settings);
            
            // Validate required fields
            if (!settings.organizationUrl || !settings.projectName || !settings.pipelineId || !settings.personalAccessToken) {
                const error = 'Please fill in all required fields';
                debugLog('Validation failed', { error, settings });
                statusEl.textContent = error;
                statusEl.className = 'status-message error visible';
                setTimeout(() => statusEl.classList.remove('visible'), 5000);
                return;
            }
            
            // Show testing status
            statusEl.textContent = 'Testing connection...';
            statusEl.className = 'status-message testing visible';
            buttonEl.disabled = true;
            
            // Send test request to plugin
            debugLog('Sending test connection request to plugin');
            streamDeckClient.send({
                event: 'testConnection',
                payload: settings
            });
        });
        
        // Listen for messages from plugin
        streamDeckClient.onSendToPropertyInspector((data) => {
            debugLog('Received from plugin', data);
            
            // Handle debug messages from plugin
            if (data.event === 'debugLog') {
                debugLog(`[PLUGIN] ${data.message}`, data.data);
                return;
            }
            
            // Handle test connection response
            if (data.event === 'testConnectionResult') {
                const statusEl = document.getElementById('connectionStatus');
                const buttonEl = document.getElementById('testConnection');
                
                buttonEl.disabled = false;
                
                if (data.success) {
                    debugLog('Connection test successful', { message: data.message });
                    statusEl.textContent = data.message || 'Connection successful!';
                    statusEl.className = 'status-message success visible';
                } else {
                    debugLog('Connection test failed', { message: data.message });
                    statusEl.textContent = data.message || 'Connection failed';
                    statusEl.className = 'status-message error visible';
                }
                
                // Hide status after 5 seconds
                setTimeout(() => {
                    statusEl.classList.remove('visible');
                }, 5000);
            }
        });
        
        // Copy logs button
        document.getElementById('copyLogs').addEventListener('click', () => {
            const debugLogElement = document.getElementById('debugLog');
            if (debugLogElement) {
                debugLogElement.select();
                document.execCommand('copy');
                
                // Show feedback
                const copyButton = document.getElementById('copyLogs');
                const originalText = copyButton.textContent;
                copyButton.textContent = 'Copied!';
                setTimeout(() => {
                    copyButton.textContent = originalText;
                }, 1500);
            }
            debugLog('Logs copied to clipboard');
        });
        
        // Clear logs button
        document.getElementById('clearLogs').addEventListener('click', () => {
            debugLogs = [];
            const debugLogElement = document.getElementById('debugLog');
            if (debugLogElement) {
                debugLogElement.value = '';
            }
            debugLog('Logs cleared');
        });
        
        // Log settings changes
        streamDeckClient.onDidReceiveSettings((settings) => {
            debugLog('Settings updated', settings);
        });
    </script>
</body>

</html>
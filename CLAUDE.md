# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an Elgato Stream Deck plugin for displaying Azure DevOps information. The plugin is built using the Elgato Stream Deck SDK v2 with TypeScript and follows the official SDK architecture patterns.

## Essential Commands

### Development Commands
```bash
# Build the plugin
npm run build

# Watch mode with auto-restart (restarts Stream Deck plugin on changes)
npm run watch
```

### Testing
The project uses Jest for testing with full test infrastructure:
- Test files are placed alongside source files with `.test.ts` or `.spec.ts` extensions
- Jest is configured in `jest.config.js` with TypeScript support via ts-jest
- Run tests with `npm test` or `npm run test:coverage` for coverage reports
- Mocks are available for Stream Deck SDK modules in `src/__mocks__/`

### Environment Configuration
The project uses a `.env` file for Azure DevOps credentials during development and testing:
- `.env` file contains actual credentials (never committed to version control)
- `.env.example` provides a template with all required variables
- Credentials are loaded using the `dotenv` package
- The `.env` file is properly excluded in `.gitignore`

Required environment variables:
- `AZURE_DEVOPS_ORG_URL`: Your Azure DevOps organization URL
- `AZURE_DEVOPS_PROJECT_NAME`: Project name within the organization
- `AZURE_DEVOPS_PAT`: Personal Access Token for authentication
- `AZURE_DEVOPS_PIPELINE_ID`: Numeric ID of the pipeline to monitor

## Architecture

### Plugin Structure
The Stream Deck plugin follows a specific directory structure:
- **com.sshadows.azure-devops-info.sdPlugin/**: The actual plugin package that Stream Deck loads
  - `manifest.json`: Plugin configuration defining actions, metadata, and entry point
  - `bin/plugin.js`: Compiled JavaScript output (generated by build)
  - `ui/`: HTML files for property inspectors (action configuration UI)
  - `imgs/`: Icons and visual assets for actions and plugin

### Source Code Architecture
- **src/plugin.ts**: Main entry point that:
  - Initializes the Stream Deck connection
  - Registers all actions
  - Sets up logging

- **src/actions/**: Contains action implementations
  - Each action extends `SingletonAction` from the SDK
  - Actions are decorated with `@action` decorator specifying their UUID
  - Actions handle Stream Deck events (onWillAppear, onKeyDown, etc.)

### Build System
- Uses Rollup for bundling TypeScript into a single plugin.js file
- TypeScript configuration extends Node.js 20 base config
- Targets ES2022 modules with Bundler module resolution
- Automatic source maps in watch mode for debugging

### Key Technical Details
- **Node.js Version**: 20 (specified in manifest.json)
- **SDK Version**: 2 (Stream Deck SDK v2)
- **Platform Support**: Windows 10+ and macOS 12+
- **Logging**: Set to TRACE level for development (see src/plugin.ts:6)

## Current Implementation Status

âœ… **COMPLETED**: The Azure DevOps pipeline status display is fully functional! The plugin successfully:
- Connects to Azure DevOps using Personal Access Tokens
- Displays real-time pipeline status with visual indicators
- **Branch Filtering**: Monitor specific branches (e.g., main, develop) or all branches
- Shows build information (version, build number, duration)
- Updates automatically at configured intervals (30-300 seconds)
- Supports multiple pipeline states (Success, Failed, Running, Partial, Canceled, Unknown, Not Started)
- Encrypts credentials using AES-256-GCM for secure storage
- Implements caching to minimize API calls
- Handles errors gracefully with retry logic and exponential backoff

### Implemented Components

#### Actions (`src/actions/`)
- **PipelineStatusAction**: Main action that displays pipeline status
  - Polls Azure DevOps at configured intervals
  - Updates Stream Deck button with status, color, and text
  - Opens pipeline in browser on button press

#### Services (`src/services/`)
- **AzureDevOpsClient**: Handles Azure DevOps API authentication and connections
- **PipelineService**: Manages pipeline status retrieval with caching

#### Utilities (`src/utils/`)
- **StatusDisplayManager**: Maps pipeline statuses to colors and formatting
- **CredentialManager**: Encrypts/decrypts PAT tokens for secure storage
- **ErrorHandler**: Comprehensive error handling with retry logic

#### UI (`com.sshadows.azure-devops-info.sdPlugin/ui/`)
- **pipeline-status.html**: Property Inspector for configuration
- **pipeline-status.css**: Styling for Property Inspector

## SDK Documentation References

Key SDK documentation for this project:
- [Getting Started](https://docs.elgato.com/streamdeck/sdk/introduction/getting-started/)
- [Actions Guide](https://docs.elgato.com/streamdeck/sdk/guides/actions)
- [Settings Guide](https://docs.elgato.com/streamdeck/sdk/guides/settings)
- [Manifest Reference](https://docs.elgato.com/streamdeck/sdk/references/manifest)

## Debugging

### Plugin Logs
The plugin writes detailed logs that are essential for debugging:
- **Log location**: `U:\Git\azure-devops-info\com.sshadows.azure-devops-info.sdPlugin\logs\com.sshadows.azure-devops-info.0.log`
- Logs include connection attempts, API calls, error messages, and state changes
- Log level is set to TRACE in development (see src/plugin.ts:6)

### Stream Deck DevTools
Stream Deck provides a Chrome DevTools interface for debugging:
- **DevTools URL**: `http://localhost:23654/`
- Access the inspector for your plugin instance
- View console logs, network requests, and debug Property Inspector communication
- Useful for debugging JavaScript errors and monitoring plugin-to-PI communication

### Common Debugging Commands
```bash
# View the latest plugin logs
type com.sshadows.azure-devops-info.sdPlugin\logs\com.sshadows.azure-devops-info.0.log

# Restart the plugin after making changes
streamdeck restart com.sshadows.azure-devops-info

# Validate plugin structure
streamdeck validate

# Build and watch for changes
npm run watch
```

### Known Issues and Solutions

#### __dirname is not defined
**Problem**: The azure-devops-node-api library uses Node.js globals like `__dirname` which don't exist in the bundled environment.
**Solution**: Added a polyfill in rollup.config.mjs to define `__dirname` globally before the code runs.